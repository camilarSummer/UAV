I$("bf2a9820527cf99addc9aff5701aad29",function(e,t,n,a,i,r,s,o,c,d,f){var l;f._$$Module=e._$klass();l=f._$$Module._$extend(t._$$EventTarget);l.__init=function(){this.__bindEvent();this.__cache=i._$$Cache._$allocate();this.__improveInfoCache=s._$$Cache._$allocate();this.getToken({parentOrigin:"163yun.com"},!0)};l.__bindEvent=function(){n._$addEvent(window,"message",this.__onMessage._$bind(this))};l.getToken=function(e,t){var n=this;this.getTokenQueue=this.getTokenQueue||[];if(this.getTokenQueue.error)this.__onError(e,n.getTokenQueue.error);else if(this.getTokenQueue.gotToken)this.__onGetSupplementInfo(e);else{this.getTokenQueue.push(e);if(!this.getTokenQueue.gettingToken){this.getTokenQueue.gettingToken=!0;this.getTokenQueue.cb=function(e,t){if(e)n.getTokenQueue.error=e;else if(t&&t.userId)n.getTokenQueue.gotToken=!0;if(n.getTokenQueue.length){for(var a=0;a<n.getTokenQueue.length;a++)if(e)n.__onError(n.getTokenQueue[a],e);else n.__onGetSupplementInfo(n.getTokenQueue[a]);n.getTokenQueue=[];n.getTokenQueue.gettingToken=!1}};this.__onGetToken(this.getTokenQueue.shift(),t)}}};l.__onMessage=function(e){e=e||window.event;this.__msgSource=e.source;this.__msgOrigin="*";this.__msgName=e.data;var t=e.source,n=e.origin,a=d.parentOrigin(n),i=e.data,r={"163.com":!0,"netease.com":!0,"netease.im":!0,"163yun.com":!0,"9yiwu.com":!0};if(r[a]){if("string"==typeof i)i=i.replace(/(^")|("$)/g,"");this.__handleMessage({source:t,origin:n,parentOrigin:a,name:i})}};l.__handleMessage=function(e){switch(e.name){case"getToken":this.getToken(e);break;case"logout":o._$logout(e);break;case"ready":this.__isReady(e)}};l.__isReady=function(e){var t=e.source,n=e.origin,a;a={name:"ready",completed:!0,ready:!0};if(t&&n)t.postMessage(JSON.stringify(a),n)};l.__onGetToken=function(e,t){return a._$promise(function(n,a){var i=r._$getToken(),s=this;if(i&&i.userId){s.getTokenQueue&&s.getTokenQueue.cb(null,i);if(t!==!0)n()}else this.__cache._$getToken({headers:{"X-hosts":e.parentOrigin},onload:function(e){if(e&&e.userId){e.localTime=(new Date).valueOf();r._$setToken(e);s.getTokenQueue&&s.getTokenQueue.cb(null,r._$getToken());if(t!==!0)n()}else{s.getTokenQueue&&s.getTokenQueue.cb({});if(t!==!0)a()}},onerror:function(e){s.getTokenQueue&&s.getTokenQueue.cb(e);a(e)}})}._$bind(this))._$then(this.__onGetSupplementInfo._$bind(this,e),this.__onError._$bind(this,e))};l.__onGetSupplementInfo=function(e){return a._$promise(function(e,t){this.__improveInfoCache._$getSupplement({onload:function(t){e(t.full)}._$bind(this),onerror:function(e){t(e)}._$bind(this)})}._$bind(this))._$then(this.__onSuccess._$bind(this,e),this.__onError._$bind(this,e))};l.__onSuccess=function(e,t){var n=e.source,a=e.origin,i,s=this;r._$getInfoFromRemote(function(o){if(o){i={name:"token",completed:"true"===o.isSubUser?!0:t,token:r._$getToken()};if(n&&a)n.postMessage(JSON.stringify(i),a)}else s.__onError(e)})};l.__onError=function(e,t){var n=e.source,a=e.origin,i;i={name:"token",completed:!1,token:"",isExclusive:t&&"identity.error.exclusive_cloud_user_can_not_login"===t.code,error:t};r._$removeToken();if(n&&a)n.postMessage(JSON.stringify(i),a)};f._$$Module._$allocate()},"1942d1711f5bf519d714279747722677","29ee6a6a75bd817732bcf069f98bcc93","3ed8db70c9711bed378468c2739fb6e7","061e7c0191cd0c301a32c58ed28d772f","2450b7763d55073c15ba1e9a388d1040","d68e0e958724738ff9c40d917b03e073","87eaa36c63226cb299fb5f3406e1e127","fd02d2baa7a8bba46cd5cb58415fbe9d","ba4514903d3cb5799bd5561d1947a819","6ea2420be501d86cb309dd114a0c7d99");
//# sourceMappingURL=./s/pt_getToken.js.map